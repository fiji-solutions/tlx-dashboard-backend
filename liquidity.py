from datetime import datetime

import numpy as np
import pandas as pd
import requests


def get_data(the_url):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3'
    }
    response = requests.get(the_url, headers=headers)
    data = response.json()["stats"]
    for i in range(0, len(data) - 1):
        data[i][0] = datetime.utcfromtimestamp(data[i][0] / 1000).strftime('%Y-%m-%d')
    del data[-1]
    return data


def calculate_correlations(liquidity, lag, ma_length):
    url = "https://www.coingecko.com/price_charts/1/usd/max.json"
    url2 = "https://www.coingecko.com/price_charts/279/usd/max.json"
    url3 = "https://www.coingecko.com/price_charts/4128/usd/max.json"

    btc_data = get_data(url)
    eth_data = get_data(url2)
    sol_data = get_data(url3)

    df_btc = pd.DataFrame(btc_data, columns=["timestamp", "price_btc"])
    df_eth = pd.DataFrame(eth_data, columns=["timestamp", "price_eth"])
    df_sol = pd.DataFrame(sol_data, columns=["timestamp", "price_sol"])
    df_liquidity = pd.DataFrame(liquidity, columns=["timestamp", "price_liquidity"])

    df_btc['timestamp'] = pd.to_datetime(df_btc['timestamp'])
    df_eth['timestamp'] = pd.to_datetime(df_eth['timestamp'])
    df_sol['timestamp'] = pd.to_datetime(df_sol['timestamp'])
    df_liquidity['timestamp'] = pd.to_datetime(df_liquidity['timestamp'])

    merged_df = pd.merge(df_btc, df_liquidity, on='timestamp')
    merged_df = pd.merge(merged_df, df_eth, on='timestamp')
    merged_df = pd.merge(merged_df, df_sol, on='timestamp')

    merged_df['price_btc'] = merged_df['price_btc'].shift(-lag)
    merged_df['price_eth'] = merged_df['price_eth'].shift(-lag)
    merged_df['price_sol'] = merged_df['price_sol'].shift(-lag)

    cumulative_correlations_btc = []
    cumulative_correlations_eth = []
    cumulative_correlations_sol = []
    sma_cumulative_correlations_btc = []
    sma_cumulative_correlations_eth = []
    sma_cumulative_correlations_sol = []
    for i in range(1, len(merged_df) + 1):
        subset_df = merged_df.iloc[:i]

        corr_btc = subset_df['price_btc'].corr(subset_df['price_liquidity'])
        corr_eth = subset_df['price_eth'].corr(subset_df['price_liquidity'])
        corr_sol = subset_df['price_sol'].corr(subset_df['price_liquidity'])

        cumulative_correlations_btc.append(corr_btc)
        cumulative_correlations_eth.append(corr_eth)
        cumulative_correlations_sol.append(corr_sol)

        if len(cumulative_correlations_btc) >= ma_length:
            sma_btc = pd.Series(cumulative_correlations_btc[-ma_length:]).mean()
            sma_eth = pd.Series(cumulative_correlations_eth[-ma_length:]).mean()
            sma_sol = pd.Series(cumulative_correlations_sol[-ma_length:]).mean()
        else:
            sma_btc = pd.Series(cumulative_correlations_btc).mean()
            sma_eth = pd.Series(cumulative_correlations_eth).mean()
            sma_sol = pd.Series(cumulative_correlations_sol).mean()

        sma_cumulative_correlations_btc.append(sma_btc)
        sma_cumulative_correlations_eth.append(sma_eth)
        sma_cumulative_correlations_sol.append(sma_sol)

    merged_df['cumulative_correlation_btc'] = cumulative_correlations_btc
    merged_df['cumulative_correlation_eth'] = cumulative_correlations_eth
    merged_df['cumulative_correlation_sol'] = cumulative_correlations_sol
    merged_df['sma_cumulative_correlation_btc'] = sma_cumulative_correlations_btc
    merged_df['sma_cumulative_correlation_eth'] = sma_cumulative_correlations_eth
    merged_df['sma_cumulative_correlation_sol'] = sma_cumulative_correlations_sol

    selected_data = merged_df[['timestamp', 'cumulative_correlation_btc', "cumulative_correlation_eth", "cumulative_correlation_sol", 'sma_cumulative_correlation_btc', 'sma_cumulative_correlation_eth', 'sma_cumulative_correlation_sol']]

    selected_data['timestamp'] = selected_data['timestamp'].dt.strftime('%Y-%m-%d')

    selected_data = selected_data.replace({np.nan: None})

    correlation_btc = [{row['timestamp']: row['cumulative_correlation_btc']} for _, row in selected_data.iterrows()]
    correlation_eth = [{row['timestamp']: row['cumulative_correlation_eth']} for _, row in selected_data.iterrows()]
    correlation_sol = [{row['timestamp']: row['cumulative_correlation_sol']} for _, row in selected_data.iterrows()]

    sma_btc = [{row['timestamp']: row['sma_cumulative_correlation_btc']} for _, row in selected_data.iterrows()]
    sma_eth = [{row['timestamp']: row['sma_cumulative_correlation_eth']} for _, row in selected_data.iterrows()]
    sma_sol = [{row['timestamp']: row['sma_cumulative_correlation_sol']} for _, row in selected_data.iterrows()]

    data = {
        "correlation_btc": correlation_btc,
        "correlation_eth": correlation_eth,
        "correlation_sol": correlation_sol,
        "sma_btc": sma_btc,
        "sma_eth": sma_eth,
        "sma_sol": sma_sol
    }

    return data


# liquidity = [["2023-03-15",6470630],["2023-03-16",6452669],["2023-03-17",6417782],["2023-03-20",6438602],["2023-03-21",6384861],["2023-03-22",6418240],["2023-03-23",6470838],["2023-03-24",6491881],["2023-03-27",6476647],["2023-03-28",6499607],["2023-03-29",6430882],["2023-03-30",6392635],["2023-03-31",6305639],["2023-04-03",6464387],["2023-04-04",6498780],["2023-04-05",6397411],["2023-04-06",6494482],["2023-04-07",6496625],["2023-04-10",6416451],["2023-04-11",6376433],["2023-04-12",6363851],["2023-04-13",6333080],["2023-04-14",6365591],["2023-04-17",6353343],["2023-04-18",6262721],["2023-04-19",6177398],["2023-04-20",6179969],["2023-04-21",6166235],["2023-04-24",6121531],["2023-04-25",6145838],["2023-04-26",6142180],["2023-04-27",6150307],["2023-04-28",6076090],["2023-05-01",6239621],["2023-05-02",6235938],["2023-05-03",6138586],["2023-05-04",6134052],["2023-05-05",6170988],["2023-05-08",6152383],["2023-05-09",6177338],["2023-05-10",6207484],["2023-05-11",6209884],["2023-05-12",6226298],["2023-05-15",6287083],["2023-05-16",6297598],["2023-05-17",6270806],["2023-05-18",6257207],["2023-05-19",6215438],["2023-05-22",6209168],["2023-05-23",6219579],["2023-05-24",6232191],["2023-05-25",6295898],["2023-05-26",6288199],["2023-05-29",6288199],["2023-05-30",6294537],["2023-05-31",6180069],["2023-06-01",6300493],["2023-06-02",6317970],["2023-06-05",6280805],["2023-06-06",6277225],["2023-06-07",6253597],["2023-06-08",6262883],["2023-06-09",6279000],["2023-06-12",6264844],["2023-06-13",6285074],["2023-06-14",6249948],["2023-06-15",6251353],["2023-06-16",6215479],["2023-06-19",6215479],["2023-06-20",6176496],["2023-06-21",6138795],["2023-06-22",6106787],["2023-06-23",6121239],["2023-06-26",6118199],["2023-06-27",6078906],["2023-06-28",6093432],["2023-06-29",6047398],["2023-06-30",6010491],["2023-07-03",6143108],["2023-07-04",6143108],["2023-07-05",6089702],["2023-07-06",6035961],["2023-07-07",6076334],["2023-07-10",6079869],["2023-07-11",6085047],["2023-07-12",6064356],["2023-07-13",6111788],["2023-07-14",6139521],["2023-07-17",6142181],["2023-07-18",6123539],["2023-07-19",6109867],["2023-07-20",6121242],["2023-07-21",6076526],["2023-07-24",6064231],["2023-07-25",6085498],["2023-07-26",6051041],["2023-07-27",6063257],["2023-07-28",6070540],["2023-07-31",6027719],["2023-08-01",6153004],["2023-08-02",6083234],["2023-08-03",6092452],["2023-08-04",6079061],["2023-08-07",6052428],["2023-08-08",6076997],["2023-08-09",6088235],["2023-08-10",6107021],["2023-08-11",6092418],["2023-08-14",6054578],["2023-08-15",6174794],["2023-08-16",6073396],["2023-08-17",6051979],["2023-08-18",6030766],["2023-08-21",6014549],["2023-08-22",6001503],["2023-08-23",6016078],["2023-08-24",6078105],["2023-08-25",6100006],["2023-08-28",6067834],["2023-08-29",6055354],["2023-08-30",6034229],["2023-08-31",6038305],["2023-09-01",6211567],["2023-09-04",6211567],["2023-09-05",6174957],["2023-09-06",6123428],["2023-09-07",6166831],["2023-09-08",6176508],["2023-09-11",6136801],["2023-09-12",6166612],["2023-09-13",6125881],["2023-09-14",6134200],["2023-09-15",6175212],["2023-09-18",6092515],["2023-09-19",6081211],["2023-09-20",5986066],["2023-09-21",5998149],["2023-09-22",6033034],["2023-09-25",6007458],["2023-09-26",5995585],["2023-09-27",5998025],["2023-09-28",5986432],["2023-09-29",5898514],["2023-10-02",6069298],["2023-10-03",6089183],["2023-10-04",6045230],["2023-10-05",6100906],["2023-10-06",6081024],["2023-10-09",6081024],["2023-10-10",6099784],["2023-10-11",6111136],["2023-10-12",6209186],["2023-10-13",6209181],["2023-10-16",6138719],["2023-10-17",6123521],["2023-10-18",6053058],["2023-10-19",6102210],["2023-10-20",6086345],["2023-10-23",6052208],["2023-10-24",6076689],["2023-10-25",6071734],["2023-10-26",6095137],["2023-10-27",6099897],["2023-10-30",6044064],["2023-10-31",6049959],["2023-11-01",6146215],["2023-11-02",6135572],["2023-11-03",6144169],["2023-11-06",6141637],["2023-11-07",6177084],["2023-11-08",6187945],["2023-11-09",6239680],["2023-11-10",6200301],["2023-11-13",6198724],["2023-11-14",6215822],["2023-11-15",6315957],["2023-11-16",6318903],["2023-11-17",6291745],["2023-11-20",6263316],["2023-11-21",6270819],["2023-11-22",6302744],["2023-11-23",6302744],["2023-11-24",6320224],["2023-11-27",6306649],["2023-11-28",6303287],["2023-11-29",6244501],["2023-11-30",6265585],["2023-12-01",6475516],["2023-12-04",6414718],["2023-12-05",6413088],["2023-12-06",6346864],["2023-12-07",6367108],["2023-12-08",6376310],["2023-12-11",6349799],["2023-12-12",6375677],["2023-12-13",6411556],["2023-12-14",6448109],["2023-12-15",6442140],["2023-12-18",6367609],["2023-12-19",6341332],["2023-12-20",6345934],["2023-12-21",6345237],["2023-12-22",6353228],["2023-12-25",6353228],["2023-12-26",6320496],["2023-12-27",6319145],["2023-12-28",6296532],["2023-12-29",6064005],["2024-01-01",6064005],["2024-01-02",6379874],["2024-01-03",6361024],["2024-01-04",6406307],["2024-01-05",6381925],["2024-01-08",6374334],["2024-01-09",6398928],["2024-01-10",6428174],["2024-01-11",6479316],["2024-01-12",6497118],["2024-01-15",6497118],["2024-01-16",6457584],["2024-01-17",6473802],["2024-01-18",6429611],["2024-01-19",6422337],["2024-01-22",6387889],["2024-01-23",6398283],["2024-01-24",6393064],["2024-01-25",6460036],["2024-01-26",6447549],["2024-01-29",6422561],["2024-01-30",6406750],["2024-01-31",6317691],["2024-02-01",6481346],["2024-02-02",6498950],["2024-02-05",6445964],["2024-02-06",6445231],["2024-02-07",6423873],["2024-02-08",6429822],["2024-02-09",6397388],["2024-02-12",6371931],["2024-02-13",6384463],["2024-02-14",6393853],["2024-02-15",6539116],["2024-02-16",6489194],["2024-02-19",6489194],["2024-02-20",6448557],["2024-02-21",6384678],["2024-02-22",6435518],["2024-02-23",6440729],["2024-02-26",6420941],["2024-02-27",6419939],["2024-02-28",6395859],["2024-02-29",6394213],["2024-03-01",6543981],["2024-03-04",6528180],["2024-03-05",6522263],["2024-03-06",6487364],["2024-03-07",6502033],["2024-03-08",6495272],["2024-03-11",6439615],["2024-03-12",6444154],["2024-03-13",6441131],["2024-03-14",6478472],["2024-03-15",6493186],["2024-03-18",6424660],["2024-03-19",6419597],["2024-03-20",6358353],["2024-03-21",6403662],["2024-03-22",6383630],["2024-03-25",6371730],["2024-03-26",6367492],["2024-03-27",6333198],["2024-03-28",6258732],["2024-03-29",6254119],["2024-04-01",6390693],["2024-04-02",6415342],["2024-04-03",6406012],["2024-04-04",6426505],["2024-04-05",6426763],["2024-04-08",6397807],["2024-04-09",6441855],["2024-04-10",6451220],["2024-04-11",6446495],["2024-04-12",6437225],["2024-04-15",6345491],["2024-04-16",6292017],["2024-04-17",6169331],["2024-04-18",6176223],["2024-04-19",6203073],["2024-04-22",6173969],["2024-04-23",6148177],["2024-04-24",6164350],["2024-04-25",6183051],["2024-04-26",6160094],["2024-04-29",6099820],["2024-04-30",6038282],["2024-05-01",6164792],["2024-05-02",6192110],["2024-05-03",6190107],["2024-05-06",6157549],["2024-05-07",6172516],["2024-05-08",6162033],["2024-05-09",6209473],["2024-05-10",6190674],["2024-05-13",6171771],["2024-05-14",6198264],["2024-05-15",6270344],["2024-05-16",6293234],["2024-05-17",6246281],["2024-05-20",6192776],["2024-05-21",6190099],["2024-05-22",6207971],["2024-05-23",6244211],["2024-05-24",6286043],["2024-05-27",6286043],["2024-05-28",6278511],["2024-05-29",6223808],["2024-05-30",6248048],["2024-05-31",6240410],["2024-06-03",6299714],["2024-06-04",6320665],["2024-06-05",6294554],["2024-06-06",6310838],["2024-06-07",6298739],["2024-06-10",6262919],["2024-06-11",6292042],["2024-06-12",6275339],["2024-06-13",6295234],["2024-06-14",6309935],["2024-06-17",6217084],["2024-06-18",6215425],["2024-06-19",6208863],["2024-06-20",6205973],["2024-06-21",6182097],["2024-06-24",6146213],["2024-06-25",6133004],["2024-06-26",6110383],["2024-06-27",6094435],["2024-06-28",5902377],["2024-07-01",6129523],["2024-07-02",6132822],["2024-07-03",6162702],["2024-07-04",6162702],["2024-07-05",6211417],["2024-07-08",6175783],["2024-07-09",6163818],["2024-07-10",6192405],["2024-07-11",6201756],["2024-07-12",6195825],["2024-07-15",6159062],["2024-07-16",6132262],["2024-07-17",6151949],["2024-07-18",6150698],["2024-07-19",6167076],["2024-07-22",6152445],["2024-07-23",6134825],["2024-07-24",6148076],["2024-07-25",6169289],["2024-07-26",6166831],["2024-07-29",6147835],["2024-07-30",6145140],["2024-07-31",6020181],["2024-08-01",6153403],["2024-08-02",6189851],["2024-08-05",6201940],["2024-08-06",6215604],["2024-08-07",6206453],["2024-08-08",6182891],["2024-08-09",6177789],["2024-08-12",6149670],["2024-08-13",6141238],["2024-08-14",6163255],["2024-08-15",6247500],["2024-08-16",6219296],["2024-08-19",6203934],["2024-08-20",6210751],["2024-08-21",6185445],["2024-08-22",6189991],["2024-08-23",6194371],["2024-08-26",6147725],["2024-08-27",6111228],["2024-08-28",6077822],["2024-08-29",6085875],["2024-08-30",6081146],["2024-09-02",6081146],["2024-09-03",6099846],["2024-09-04",6104060],["2024-09-05",6152206],["2024-09-06",6153312],["2024-09-09",6148856],["2024-09-10",6184932],["2024-09-11",6209444],["2024-09-12",6194195]]
# lag = 0
# ma_length = 14
#
# calculate_correlations(liquidity, lag, ma_length)
